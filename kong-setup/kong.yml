_format_version: "3.0"
_transform: true

services:
  - name: auth-service
    url: http://host.docker.internal:8081
    routes:
      - name: auth
        paths:
          - /api/auth/v1
        strip_path: false

  - name: last-word-service
    url: http://host.docker.internal:8082
    routes:
      - name: last-word
        paths:
          - /api/last-word/v1
        strip_path: false
        plugins:
          - name: pre-function
            config:
              access:
                - |
                  local http = require "resty.http"
                  local client = http.new()
                  
                  -- 1. Token'ı al ve temizle
                  local auth_header = ngx.var.http_authorization
                  local token = ""
                  if auth_header then
                      -- "Bearer " kısmını kaldır, sadece token kalsın
                      token = auth_header:gsub("Bearer ", "")
                  end

                  -- 2. Java Constants'a göre tam adresi oluştur:
                  -- AUTH(/api/auth) + V1(/v1) + VALIDATE(/validate) + /{token}
                  local target_url = "http://host.docker.internal:8081/api/auth/v1/validate/" .. token

                  -- 3. İsteği POST olarak at
                  local res, err = client:request_uri(target_url, {
                    method = "POST",
                    headers = {
                      ["Content-Type"] = "application/json",
                    }
                  })

                  -- 4. Hata Ayıklama (Log): Java'ya ulaşamazsa veya hata alırsa Docker loglarında görelim
                  if not res then
                    ngx.log(ngx.ERR, "AUTH SERVISINE BAGLANILAMADI: ", err)
                    ngx.status = 500
                    ngx.say('{"error": "Auth service down"}')
                    return ngx.exit(500)
                  end

                  -- 5. Eğer Java 200 (OK) dönmezse Kong kapıyı kapatır
                  if res.status ~= 200 then
                    ngx.status = res.status
                    ngx.header.content_type = "application/json"
                    ngx.say(res.body) -- Java'dan gelen hata mesajını aynen döner
                    return ngx.exit(res.status)
                  end

  - name: user-profile-service
    url: http://host.docker.internal:8083
    routes:
      - name: user-profile
        paths:
          - /api/user-profile/v1
        strip_path: false