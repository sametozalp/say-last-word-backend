_format_version: "3.0"
_transform: true

services:
  - name: auth-service
    url: http://host.docker.internal:8081
    routes:
      - name: auth
        paths:
          - /api/auth

  - name: last-word-service
    url: http://host.docker.internal:8082
    routes:
      - name: last-word
        paths:
          - /api/last-word
        strip_path: true
        plugins:
          - name: pre-function
            config:
              access:
                - |
                  local http = require "resty.http"
                  local client = http.new()
                  -- Auth servisine istek atıyoruz
                  local res, err = client:request_uri("http://host.docker.internal:8081/validate", {
                    method = "GET",
                    headers = {
                      ["Authorization"] = ngx.var.http_authorization, -- Gelen token'ı aynen ilet
                    }
                  })

                  -- Eğer auth servisi 200 dönmezse kapıyı kapat
                  if not res or res.status ~= 200 then
                    ngx.status = res and res.status or 401
                    ngx.header.content_type = "application/json"
                    ngx.say('{"error": "Yetkisiz Erişim", "message": "Auth servisinden onay alınamadı"}')
                    ngx.exit(ngx.status)
                  end

  - name: user-profile-service
    url: http://host.docker.internal:8083
    routes:
      - name: user-profile
        paths:
          - /api/user-profile